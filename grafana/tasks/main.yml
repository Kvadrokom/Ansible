---
- name: Check if Grafana is already installed
  ansible.builtin.shell:
    cmd: "dpkg -l grafana | grep -q '^ii' && echo 'installed' || echo 'not_installed'"
  register: grafana_installed
  changed_when: false
  tags: [grafana]

- name: Check if files already exist on Ansible Host
  block:
    - name: Check if GPG key exists on Ansible Host
      ansible.builtin.stat:
        path: "/tmp/grafana-gpg.key"
      register: grafana_gpg_file_ansible

    - name: Check if DEB package exists on Ansible Host
      ansible.builtin.stat:
        path: "/tmp/grafana.deb"
      register: grafana_deb_file_ansible
  delegate_to: localhost
  become: no
  tags: [download]

- name: Check if SOCKS tunnel is already running
  ansible.builtin.shell:
    cmd: "ss -tln | grep ':1080' || exit 1"
  delegate_to: localhost
  become: no
  register: socks_tunnel_check
  ignore_errors: yes
  changed_when: false
  tags: [tunnel]

- name: Start SOCKS tunnel from Ansible Host to telebot for internet access
  ansible.builtin.shell:
    cmd: |
      ssh -f -N -D 1080 {{ hostvars['telebot']['ansible_host'] }} \
      -o StrictHostKeyChecking=no \
      -o BatchMode=yes \
      -o ConnectTimeout=30
  delegate_to: localhost
  become: no
  when: >
    grafana_installed.stdout != "installed" and 
    (not grafana_deb_file_ansible.stat.exists or not grafana_gpg_file_ansible.stat.exists) and
    socks_tunnel_check.rc != 0
  changed_when: false
  tags: [tunnel]

- name: Wait for tunnel to be ready
  ansible.builtin.wait_for:
    port: 1080
    host: 127.0.0.1
    timeout: 10
  delegate_to: localhost
  become: no
  when: >
    grafana_installed.stdout != "installed" and 
    (not grafana_deb_file_ansible.stat.exists or not grafana_gpg_file_ansible.stat.exists)
  tags: [tunnel]

- name: Download Grafana files to Ansible Host via SOCKS tunnel
  block:
    - name: Download Grafana GPG key to Ansible Host via SOCKS
      ansible.builtin.get_url:
        url: "https://packages.grafana.com/gpg.key"
        dest: "/tmp/grafana-gpg.key"
      delegate_to: localhost
      become: no
      environment:
        https_proxy: "socks5://localhost:1080"
        http_proxy: "socks5://localhost:1080"
      when: not grafana_gpg_file_ansible.stat.exists
      tags: [download]

    - name: Download Grafana package to Ansible Host via SOCKS
      ansible.builtin.get_url:
        url: "https://dl.grafana.com/oss/release/grafana_{{ grafana_version }}_amd64.deb"
        dest: "/tmp/grafana.deb"
      delegate_to: localhost
      become: no
      environment:
        https_proxy: "socks5://localhost:1080"
        http_proxy: "socks5://localhost:1080"
      when: not grafana_deb_file_ansible.stat.exists
      tags: [download]

    - name: Verify downloaded files on Ansible Host
      ansible.builtin.shell:
        cmd: |
          echo "=== GPG Key ==="
          head -2 /tmp/grafana-gpg.key
          echo "=== DEB Package ==="
          file /tmp/grafana.deb
      delegate_to: localhost
      become: no
      register: file_verify_ansible
      changed_when: false
      tags: [download]

    - name: Debug Ansible Host files
      ansible.builtin.debug:
        var: file_verify_ansible.stdout
      tags: [download]
  when: >
    grafana_installed.stdout != "installed" and 
    (not grafana_deb_file_ansible.stat.exists or not grafana_gpg_file_ansible.stat.exists)

- name: Stop SSH tunnel (only if we started it)
  ansible.builtin.shell:
    cmd: "pkill -f 'ssh.*1080.*{{ hostvars['telebot']['ansible_host'] }}'"
  delegate_to: localhost
  become: no
  changed_when: false
  when: >
    grafana_installed.stdout != "installed" and 
    (not grafana_deb_file_ansible.stat.exists or not grafana_gpg_file_ansible.stat.exists) and
    socks_tunnel_check.rc != 0
  tags: [tunnel]

- name: Check if files exist on target host
  block:
    - name: Check if GPG key exists on target host
      ansible.builtin.stat:
        path: "/tmp/grafana-gpg.key"
      register: grafana_gpg_file_target

    - name: Check if DEB package exists on target host
      ansible.builtin.stat:
        path: "/tmp/grafana.deb"
      register: grafana_deb_file_target
  tags: [download]

- name: Copy files from Ansible Host to target host
  block:
    - name: Copy GPG key to target host
      ansible.builtin.copy:
        src: "/tmp/grafana-gpg.key"
        dest: "/tmp/grafana-gpg.key"
      when: not grafana_gpg_file_target.stat.exists

    - name: Copy DEB package to target host
      ansible.builtin.copy:
        src: "/tmp/grafana.deb"
        dest: "/tmp/grafana.deb"
      when: not grafana_deb_file_target.stat.exists

    - name: Verify files on target host
      ansible.builtin.shell:
        cmd: |
          echo "=== GPG Key on Target ==="
          ls -la /tmp/grafana-gpg.key && head -2 /tmp/grafana-gpg.key
          echo "=== DEB Package on Target ==="
          ls -la /tmp/grafana.deb && file /tmp/grafana.deb
      register: target_files_verify
      changed_when: false
      tags: [download]
  when: >
    grafana_installed.stdout != "installed" and 
    (not grafana_deb_file_target.stat.exists or not grafana_gpg_file_target.stat.exists)
  tags: [download]

- name: Include OS-specific variables
  include_vars: "{{ item }}"
  loop:
    - "{{ ansible_distribution | lower }}_{{ ansible_distribution_major_version | lower }}.yml"
    - "{{ ansible_os_family | lower }}_{{ ansible_distribution_major_version | lower }}.yml"
  ignore_errors: yes
  tags: [repository]

- name: Update apt package cache (local)
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [packages, repository]

- name: Install required system packages
  apt:
    name:
      - apt-transport-https
      - software-properties-common
      - wget
      - gnupg
    state: present
    update_cache: yes
  tags: [packages, dependencies]

- name: Add Grafana GPG key from local file
  apt_key:
    file: "/tmp/grafana-gpg.key"
    state: present
  when: grafana_installed.stdout != "installed"
  tags: [repository]

- name: Install Grafana from local package
  block:
    - name: Install dependencies for Grafana
      apt:
        name:
          - adduser
          - libfontconfig1
        state: present

    - name: Install Grafana package using apt (local file)
      ansible.builtin.apt:
        deb: "/tmp/grafana.deb"
        state: present

  when: grafana_installed.stdout != "installed"
  tags: [grafana, packages]

- name: Create Grafana directories
  file:
    path: "{{ item.path | default(item) }}"
    state: directory
    owner: "{{ grafana_service_user }}"
    group: "{{ grafana_service_group }}"
    mode: "{{ item.mode | default('0755') }}"
    recurse: "{{ item.recurse | default(no) }}"
  loop:
    - path: "{{ grafana_data_dir }}"
    - path: "{{ grafana_log_dir }}"
    - path: "{{ grafana_install_dir }}/data"
    - path: "{{ grafana_install_dir }}/conf"
      recurse: yes
  tags: [configuration, directories]

- name: Deploy Grafana configuration
  template:
    src: grafana.ini.j2
    dest: "{{ grafana_install_dir }}/conf/grafana.ini"
    owner: "{{ grafana_service_user }}"
    group: "{{ grafana_service_group }}"
    mode: '0640'
    backup: yes
  notify: restart grafana
  tags: [configuration]

- name: Ensure Grafana service is enabled and started
  systemd:
    name: "{{ grafana_service_name }}"
    state: "{{ grafana_service_state }}"
    enabled: "{{ grafana_service_enabled }}"
    daemon_reload: yes
  tags: [service]

- name: Wait for Grafana to start
  wait_for:
    port: "{{ grafana_http_port }}"
    host: "{{ grafana_http_addr }}"
    delay: 10
    timeout: 60
  when: grafana_service_state == "started"
  tags: [service, verification]

- name: Verify Grafana service health
  uri:
    url: "http://localhost:{{ grafana_http_port }}/api/health"
    method: GET
    status_code: 200
    timeout: 30
  register: grafana_health
  until: grafana_health.status == 200
  retries: 10
  delay: 5
  when: grafana_service_state == "started"
  tags: [verification, health-check]

- name: Cleanup temporary files on target host
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/grafana-gpg.key"
    - "/tmp/grafana.deb"
  when: grafana_installed.stdout == "installed"
  tags: [cleanup]

- name: Cleanup temporary files on Ansible Host (optional)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/grafana-gpg.key"
    - "/tmp/grafana.deb"
  delegate_to: localhost
  become: no
  when: grafana_installed.stdout == "installed"
  tags: [cleanup]