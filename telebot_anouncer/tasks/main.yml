---
- name: Ensure Git is installed
  apt:
    name: git
    state: present
  notify: –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏ git

- name: üîç DEBUG - SSH/Git –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  block:
    - name: 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Ö–æ—Å—Ç–µ
      shell: |
        echo "=== –ö–¢–û –Ø? ==="
        whoami
        id
        echo "–î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $HOME"
        echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
      register: debug_whoami
      changed_when: false
    
    - name: 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      shell: |
        echo "=== SSH –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==="
        echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .ssh:"
        ls -la ~/.ssh/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .ssh –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ known_hosts:"
        cat ~/.ssh/known_hosts 2>/dev/null | grep -i github || echo "GitHub –Ω–µ –≤ known_hosts"
        echo ""
        echo "SSH –∫–ª—é—á–∏:"
        ls -la ~/.ssh/id_* 2>/dev/null || echo "SSH –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
      register: debug_ssh
      changed_when: false
      ignore_errors: true
    
    - name: 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GitHub
      shell: |
        echo "=== –ü–†–û–í–ï–†–ö–ê GITHUB ==="
        echo "–ü–∏–Ω–≥ github.com:"
        ping -c 2 github.com 2>/dev/null && echo "–î–æ—Å—Ç—É–ø–µ–Ω" || echo "–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub:"
        ssh -T git@github.com 2>&1 | head -5
        echo ""
        echo "Exit code SSH —Ç–µ—Å—Ç–∞: $?"
      register: debug_github
      changed_when: false
      ignore_errors: true
    
    - name: 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É –∏–∑ –æ—à–∏–±–∫–∏
      shell: |
        echo "=== –ö–û–ú–ê–ù–î–ê –ò–ó –û–®–ò–ë–ö–ò ==="
        echo "–ö–æ–º–∞–Ω–¥–∞: /usr/bin/git ls-remote git@github.com:Kvadrokom/telegrambot.git -h refs/heads/develop"
        echo ""
        echo "–ü—É—Ç—å –∫ git:"
        which git
        echo ""
        echo "–í–µ—Ä—Å–∏—è git:"
        git --version
        echo ""
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É —Å –æ—Ç–ª–∞–¥–∫–æ–π SSH:"
        GIT_SSH_COMMAND="ssh -v" /usr/bin/git ls-remote git@github.com:Kvadrokom/telegrambot.git -h refs/heads/develop 2>&1 | head -20
      register: debug_git_command
      changed_when: false
      ignore_errors: true
    
    - name: 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Ansible
      debug:
        msg: |
          === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ANSIBLE ===
          –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Git –æ–ø–µ—Ä–∞—Ü–∏–∏:
          - github_repo: {{ github_repo }}
          - git_branch: {{ git_branch }}
          - deploy_dir: {{ deploy_dir }}
          
          –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
          - ansible_user: {{ ansible_user | default('–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ') }}
          - ansible_become: {{ ansible_become | default('–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ') }}
          - ansible_become_user: {{ ansible_become_user | default('–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ') }}
          
          –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
          - inventory_hostname: {{ inventory_hostname }}
          - delegate_to: {{ delegate_to | default('–Ω–µ—Ç') }}
          - stand_type: {{ stand_type | default('–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ') }}
          
          –°–µ–∫—Ä–µ—Ç—ã (–ø–µ—Ä–≤—ã–µ 5 —Å–∏–º–≤–æ–ª–æ–≤):
          - github_repo: {{ github_repo[:10] }}...
    
    - name: 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSH –∫–ª—é—á –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
      shell: |
        echo "=== SSH –ê–ì–ï–ù–¢ –ò –ö–õ–Æ–ß–ò ==="
        echo "SSH_AUTH_SOCK: ${SSH_AUTH_SOCK:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
        echo ""
        echo "–°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –≤ –∞–≥–µ–Ω—Ç–µ:"
        ssh-add -l 2>/dev/null || echo "–ê–≥–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –∫–ª—é—á–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"
        echo ""
        echo "–ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å –∫–ª—é—á–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:"
        ssh -o BatchMode=yes -o ConnectTimeout=5 git@github.com 2>&1 | head -3
      register: debug_ssh_keys
      changed_when: false
      ignore_errors: true

  always:
    - name: üìã –í–´–í–û–î –í–°–ï–• –î–ï–ë–ê–ì-–î–ê–ù–ù–´–•
      debug:
        msg: |
          =========== –û–¢–ß–ï–¢ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===========
          
          üßë –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨:
          {{ debug_whoami.stdout }}
          
          üîê SSH –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:
          {{ debug_ssh.stdout }}
          
          üåê GITHUB –î–û–°–¢–£–ü:
          {{ debug_github.stdout }}
          
          ‚öôÔ∏è  GIT –ö–û–ú–ê–ù–î–ê:
          {{ debug_git_command.stdout }}
          
          üîë SSH –ö–õ–Æ–ß–ò:
          {{ debug_ssh_keys.stdout }}
          =========================================

# –£–î–ê–õ–ò–¢–¨ —ç—Ç—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É - –æ–Ω–∞ —É–∂–µ –µ—Å—Ç—å –Ω–∏–∂–µ!
# - name: Clone or Update Repository
#   git:
#     repo: "{{ github_repo }}"
#     dest: "{{ deploy_dir }}"
#     version: "{{ git_branch }}"
#     force: no

- name: Clone or Update Repository
  git:
    repo: "{{ github_repo }}"
    dest: "{{ deploy_dir }}"
    version: "{{ git_branch }}"
    force: no

- name: –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
  copy:  # –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å copy –≤–º–µ—Å—Ç–æ shell
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0755'
  with_items:
    - { src: "{{ deploy_dir }}/telegram_bot.py", dest: "{{ dest_dir }}" }
    - { src: "{{ deploy_dir }}/logger.py", dest: "{{ dest_dir }}" }
  notify: –£–¥–∞–ª—è–µ–º –ø–∞–ø–∫—É —Å —Ñ–∞–π–ª–∞–º–∏ git

- name: Stop telegrambot service
  systemd:
    name: "{{ tele_bot }}"
    state: stopped

- name: Start telegrambot service
  systemd:
    name: "{{ tele_bot }}"
    enabled: yes
    state: started
  register: service_status

- name: Wait for service to fully initialize
  wait_for:
    timeout: 10
  when: service_status.changed

- name: Check service status after delay
  systemd:
    name: "{{ tele_bot }}"  # –ë—ã–ª–æ "reminder", –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "{{ tele_bot }}"
  register: service_status

# - name: Show ALL service_status data
#   debug:
#     var: service_status

- name: Verify service is active and running
  assert:
    that:
      - service_status.status.ActiveState == 'active'
      - service_status.status.SubState == 'running'
    msg: "Service {{ tele_bot }} is not running. Status: {{ service_status.status }}"