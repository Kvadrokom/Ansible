---
- name: Check if Zabbix is already installed
  package_facts:
    manager: auto
  register: pkg_facts

- name: Install minimal dependencies
  apt:
    name:
      - ca-certificates
      - python3-psycopg2
    state: present
  when: ("ca-certificates" not in pkg_facts.ansible_facts.packages or
         "python3-psycopg2" not in pkg_facts.ansible_facts.packages)

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Add Zabbix repository
  apt_repository:
    repo: "deb [trusted=yes] https://repo.zabbix.com/zabbix/6.0/debian bullseye main"
    state: present
    filename: zabbix
  register: zabbix_repo_added

- name: Update cache after adding Zabbix repo
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: zabbix_repo_added.changed

- name: Install Zabbix packages with PostgreSQL
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - zabbix-server-pgsql
    - zabbix-frontend-php
    - zabbix-apache-conf
    - zabbix-agent
    - zabbix-sql-scripts
    - postgresql
    - postgresql-contrib
  notify:
    - Restart Zabbix server
    - Restart Zabbix agent

- name: Create Zabbix directories
  file:
    path: "{{ item }}"
    state: directory
    owner: zabbix
    group: zabbix
    mode: '0755'
  loop:
    - /run/zabbix
    - /var/log/zabbix
    - /var/lib/zabbix
    - /etc/zabbix/zabbix_agentd.d

- name: Ensure PostgreSQL is started and enabled
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Wait for PostgreSQL to start
  wait_for:
    path: /var/run/postgresql/.s.PGSQL.5432
    state: present
    timeout: 30

- name: Check if Zabbix database user exists
  become: yes
  become_user: postgres
  shell: |
    psql -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ zabbix_db_user }}'" | grep -q 1
  register: zabbix_user_exists
  changed_when: false
  ignore_errors: yes

- name: Create Zabbix database user
  become: yes
  become_user: postgres
  postgresql_user:
    name: "{{ zabbix_db_user }}"
    password: "{{ zabbix_db_password }}"
    role_attr_flags: "CREATEDB,NOSUPERUSER"
    state: present
  when: zabbix_user_exists.rc != 0

- name: Check if Zabbix database exists
  become: yes
  become_user: postgres
  shell: |
    psql -l | grep -q "{{ zabbix_db_name }}|"
  register: zabbix_db_exists
  changed_when: false
  ignore_errors: yes

- name: Create Zabbix database
  become: yes
  become_user: postgres
  postgresql_db:
    name: "{{ zabbix_db_name }}"
    owner: "{{ zabbix_db_user }}"
    encoding: UTF8
    template: template0
    state: present
  when: zabbix_db_exists.rc != 0

- name: Set search_path to public only
  become: yes
  become_user: postgres
  shell: |
    psql -d "{{ zabbix_db_name }}" -c "ALTER DATABASE {{ zabbix_db_name }} SET search_path TO public;"

- name: Check if Zabbix tables exist
  become: yes
  become_user: postgres
  shell: |
    psql -d "{{ zabbix_db_name }}" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_name IN ('dbversion', 'hosts', 'items')" | tr -d ' \n'
  register: zabbix_tables_count
  changed_when: false

- name: Load Zabbix database schema
  become: yes
  become_user: postgres
  shell: |
    zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | psql -d "{{ zabbix_db_name }}" -v ON_ERROR_STOP=1
  when: zabbix_tables_count.stdout == "0"

- name: Configure Zabbix server settings
  lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: "^{{ item.option }}=.*"
    line: "{{ item.option }}={{ item.value }}"
    state: present
    backup: yes
  loop:
    - { option: DBHost, value: localhost }
    - { option: DBName, value: "{{ zabbix_db_name }}" }
    - { option: DBUser, value: "{{ zabbix_db_user }}" }
    # ВАЖНО: НЕТ параметра DBSchema!
    - { option: DBPassword, value: "{{ zabbix_db_password }}" }
    - { option: DBPort, value: "5432" }
    - { option: User, value: zabbix }
    - { option: PidFile, value: /run/zabbix/zabbix_server.pid }
    # Настройки для алертов
    - { option: StartAlerters, value: 3 }
    - { option: AlertScriptsPath, value: /usr/lib/zabbix/alertscripts }
    - { option: EnableRemoteCommands, value: 1 }
  notify: Restart Zabbix server

- name: Fix Zabbix server config permissions
  file:
    path: /etc/zabbix/zabbix_server.conf
    owner: zabbix
    group: zabbix
    mode: '0640'

- name: Configure Zabbix agent
  copy:
    content: |
      PidFile=/run/zabbix/zabbix_agentd.pid
      LogFile=/var/log/zabbix/zabbix_agentd.log
      LogFileSize=0
      Server=127.0.0.1
      ServerActive=127.0.0.1
      Hostname={{ ansible_hostname }}
      Include=/etc/zabbix/zabbix_agentd.d/*.conf
    dest: /etc/zabbix/zabbix_agentd.conf
    owner: zabbix
    group: zabbix
    mode: '0640'
  notify: Restart Zabbix agent

- name: Configure PHP settings for Zabbix
  lineinfile:
    path: /etc/php/7.4/apache2/php.ini
    regexp: "^{{ item.option }} =.*"
    line: "{{ item.option }} = {{ item.value }}"
    state: present
    backup: yes
  loop:
    - { option: post_max_size, value: "16M" }
    - { option: max_execution_time, value: "300" }
    - { option: max_input_time, value: "300" }
    - { option: memory_limit, value: "128M" }
    - { option: date.timezone, value: "{{ php_timezone }}" }
  notify: Restart Apache

- name: Install required PHP modules for Zabbix
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - php7.4-pgsql
    - php7.4-bcmath
    - php7.4-mbstring
    - php7.4-gd
    - php7.4-xml
    - php7.4-ldap
    - php7.4-curl
  notify: Restart Apache

- name: Create Zabbix Apache configuration
  copy:
    dest: /etc/apache2/sites-available/zabbix.conf
    content: |
      <VirtualHost *:80>
          ServerName {{ ansible_host }}
          DocumentRoot /usr/share/zabbix

          <Directory "/usr/share/zabbix">
              Options FollowSymLinks
              AllowOverride None
              Require all granted
          </Directory>

          <Directory "/usr/share/zabbix/conf">
              Require all denied
          </Directory>

          ErrorLog ${APACHE_LOG_DIR}/zabbix_error.log
          CustomLog ${APACHE_LOG_DIR}/zabbix_access.log combined
      </VirtualHost>
    owner: root
    group: root
    mode: '0644'
  notify: Restart Apache

- name: Enable Zabbix Apache site
  command:
    cmd: a2ensite zabbix.conf
    creates: "/etc/apache2/sites-enabled/zabbix.conf"
  notify: Restart Apache

- name: Disable default Apache site
  command:
    cmd: a2dissite 000-default.conf
  notify: Restart Apache

- name: Enable required Apache modules
  command:
    cmd: "a2enmod {{ item }}"
    creates: "/etc/apache2/mods-enabled/{{ item }}.load"
  loop:
    - rewrite
    - dir
  notify: Restart Apache

- name: Ensure services are enabled and started
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - zabbix-server
    - zabbix-agent
    - apache2
    - postgresql

- name: Wait for Apache to start
  wait_for:
    host: localhost
    port: 80
    timeout: 30
  ignore_errors: yes