---
- name: Install dependencies for apt key
  apt:
    name:
      - gnupg
      - ca-certificates
      - apt-transport-https
    state: present

- name: Temporarily disable problematic repositories
  block:
    - name: Comment out bullseye-backports in sources.list
      replace:
        path: /etc/apt/sources.list
        regexp: '^deb.*bullseye-backports'
        replace: '# \g<0>'
      register: backports_disabled

    - name: Comment out bullseye-backports in sources.list.d files
      find:
        paths: /etc/apt/sources.list.d
        patterns: "*.list"
        contains: "bullseye-backports"
      register: backports_files

    - name: Disable backports in found files
      replace:
        path: "{{ item.path }}"
        regexp: '^deb.*bullseye-backports'
        replace: '# \g<0>'
      loop: "{{ backports_files.files }}"
      when: backports_files.matched > 0
  rescue:
    - name: Continue even if repository disabling fails
      debug:
        msg: "Could not disable backports repositories, continuing anyway"

- name: Update package repositories
  apt:
    update_cache: yes
    cache_valid_time: 3600
  ignore_errors: yes

- name: Add Zabbix repository key
  apt_key:
    url: "https://repo.zabbix.com/zabbix-official-repo.key"
    state: present

- name: Add Zabbix repository for Debian 11
  apt_repository:
    repo: "deb https://repo.zabbix.com/zabbix/{{ zabbix_version | default('6.0') }}/debian bullseye main"
    state: present
    filename: zabbix

- name: Update cache with Zabbix repository
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required packages
  apt:
    name:
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-agent
      - mariadb-server
      - python3-pymysql
    state: present

- name: Install locales package
  apt:
    name: 
      - locales
      - locales-all
    state: present

- name: Generate en_US.UTF-8 locale
  locale_gen:
    name: en_US.UTF-8
    state: present

- name: Set system locale
  copy:
    content: |
      LANG=en_US.UTF-8
      LC_ALL=en_US.UTF-8
    dest: /etc/default/locale

- name: Configure Apache locale environment
  blockinfile:
    path: /etc/apache2/envvars
    marker: "# {mark} ANSIBLE MANAGED BLOCK - LOCALE"
    block: |
      export LANG=en_US.UTF-8
      export LC_ALL=en_US.UTF-8
    state: present

- name: Create Zabbix user and group
  user:
    name: zabbix
    system: yes
    shell: /bin/false
    home: /var/lib/zabbix
    create_home: yes
    state: present

- name: Create Zabbix directories
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('zabbix') }}"
    group: "{{ item.group | default('zabbix') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - { path: /run/zabbix }
    - { path: /var/log/zabbix }
    - { path: /var/lib/zabbix }
    - { path: /etc/zabbix, owner: root, group: root }

- name: Ensure MariaDB is started and enabled
  systemd:
    name: mariadb
    state: started
    enabled: yes

- name: Wait for MariaDB to start
  wait_for:
    path: /var/run/mysqld/mysqld.sock
    state: present
    timeout: 30

- name: Check if MySQL root password is already set
  shell: |
    mysql -u root -e "SELECT 1;" 2>/dev/null && echo "no_password" || echo "has_password"
  register: mysql_password_check
  changed_when: false
  ignore_errors: true

- name: Set MySQL root password if no password set
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
    priv: "*.*:ALL,GRANT"
    state: present
  when: "'no_password' in mysql_password_check.stdout"

- name: Set MySQL root password if password already set
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    priv: "*.*:ALL,GRANT"
    state: present
  when: "'has_password' in mysql_password_check.stdout"

- name: Remove anonymous MySQL users
  mysql_user:
    name: ''
    host_all: yes
    state: absent
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: Remove test database
  mysql_db:
    name: test
    state: absent
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: Create Zabbix database
  mysql_db:
    name: "{{ zabbix_db_name | default('zabbix') }}"
    encoding: utf8mb4
    collation: utf8mb4_bin
    login_user: root
    login_password: "{{ mysql_root_password }}"
    state: present

- name: Create Zabbix DB user
  mysql_user:
    name: "{{ zabbix_db_user | default('zabbix') }}"
    password: "{{ zabbix_db_password }}"
    host: localhost
    priv: "{{ zabbix_db_name | default('zabbix') }}.*:ALL"
    login_user: root
    login_password: "{{ mysql_root_password }}"
    state: present

- name: Load Zabbix database schema
  mysql_db:
    name: "{{ zabbix_db_name | default('zabbix') }}"
    state: import
    target: /usr/share/zabbix-sql-scripts/mysql/server.sql.gz
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: Configure Zabbix server settings
  lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: "^{{ item.option }}=.*"
    line: "{{ item.option }}={{ item.value }}"
    state: present
  loop:
    - { option: DBHost, value: localhost }
    - { option: DBName, value: "{{ zabbix_db_name | default('zabbix') }}" }
    - { option: DBUser, value: "{{ zabbix_db_user | default('zabbix') }}" }
    - { option: DBPassword, value: "{{ zabbix_db_password }}" }
    - { option: User, value: zabbix }
    - { option: PidFile, value: /run/zabbix/zabbix_server.pid }
  notify: Restart Zabbix server

- name: Configure Zabbix agent settings
  lineinfile:
    path: /etc/zabbix/zabbix_agentd.conf
    regexp: "^{{ item.option }}=.*"
    line: "{{ item.option }}={{ item.value }}"
    state: present
  loop:
    - { option: Server, value: 127.0.0.1 }
    - { option: User, value: zabbix }
    - { option: PidFile, value: /run/zabbix/zabbix_agentd.pid }
  notify: Restart Zabbix agent

- name: Configure PHP timezone for Apache
  lineinfile:
    path: /etc/php/7.4/apache2/php.ini
    regexp: "^;?date.timezone.*"
    line: "date.timezone = {{ php_timezone | default('Europe/Moscow') }}"
    state: present
  notify: Reload Apache

- name: Enable Apache site for Zabbix
  file:
    src: /etc/zabbix/apache.conf
    dest: /etc/apache2/sites-available/zabbix.conf
    state: link
  notify: Restart Apache

- name: Enable Apache modules
  apache2_module:
    name: "{{ item }}"
    state: present
  loop:
    - rewrite
  notify: Restart Apache

- name: Enable Zabbix Apache site
  command:
    cmd: a2ensite zabbix.conf
    creates: /etc/apache2/sites-enabled/zabbix.conf
  notify: Restart Apache

- name: Disable default Apache site
  command:
    cmd: a2dissite 000-default.conf
    removes: /etc/apache2/sites-enabled/000-default.conf
  notify: Restart Apache

- name: Fix Zabbix systemd services
  blockinfile:
    path: "/lib/systemd/system/{{ item }}.service"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SERVICE FIX"
    block: |
      [Service]
      Type=simple
      User=zabbix
      Group=zabbix
      PIDFile=/run/zabbix/{{ item }}.pid
      RuntimeDirectory=zabbix
      RuntimeDirectoryMode=0755
    state: present
    insertafter: "[Unit]"
  loop:
    - zabbix-server
    - zabbix-agent
  notify: Reload systemd

- name: Remove any existing corrupted PID files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /run/zabbix/zabbix_server.pid
    - /run/zabbix/zabbix_agentd.pid
  ignore_errors: true

- name: Ensure services are enabled and started
  systemd:
    name: "{{ item }}"
    state: restarted
    enabled: yes
    daemon_reload: yes
  loop:
    - zabbix-server
    - zabbix-agent
    - apache2

- name: Flush handlers
  meta: flush_handlers