---
- name: Install dependencies for apt key
  apt:
    name:
      - gnupg
      - ca-certificates
      - apt-transport-https
    state: present

- name: Temporarily disable problematic repositories
  block:
    - name: Comment out bullseye-backports in sources.list
      replace:
        path: /etc/apt/sources.list
        regexp: '^deb.*bullseye-backports'
        replace: '# \g<0>'
      register: backports_disabled

    - name: Comment out bullseye-backports in sources.list.d files
      find:
        paths: /etc/apt/sources.list.d
        patterns: "*.list"
        contains: "bullseye-backports"
      register: backports_files

    - name: Disable backports in found files
      replace:
        path: "{{ item.path }}"
        regexp: '^deb.*bullseye-backports'
        replace: '# \g<0>'
      loop: "{{ backports_files.files }}"
      when: backports_files.matched > 0
  rescue:
    - name: Continue even if repository disabling fails
      debug:
        msg: "Could not disable backports repositories, continuing anyway"

- name: Update package repositories
  apt:
    update_cache: yes
    cache_valid_time: 3600
  ignore_errors: yes

- name: Add Zabbix repository key
  apt_key:
    url: "https://repo.zabbix.com/zabbix-official-repo.key"
    state: present

- name: Add Zabbix repository for Debian 11
  apt_repository:
    repo: "deb https://repo.zabbix.com/zabbix/{{ zabbix_version | default('6.0') }}/debian bullseye main"
    state: present
    filename: zabbix

- name: Update cache with Zabbix repository
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required packages
  apt:
    name:
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-agent
      - mariadb-server
      - python3-pymysql
    state: present
    force_apt_get: yes

- name: Ensure MariaDB is started and enabled
  systemd:
    name: mariadb
    state: started
    enabled: yes

- name: Wait for MariaDB to start
  wait_for:
    path: /var/run/mysqld/mysqld.sock
    state: present
    timeout: 30

- name: Check if MySQL root password is already set
  shell: |
    mysqladmin -u root status 2>/dev/null && echo "no_password" || mysqladmin -u root -p"{{ mysql_root_password }}" status 2>/dev/null && echo "has_password" || echo "error"
  register: mysql_root_check
  changed_when: false
  ignore_errors: true

- name: Set MySQL root password if not set
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: yes
    priv: "*.*:ALL,GRANT"
    state: present
  when: "'no_password' in mysql_root_check.stdout"

- name: Secure other root accounts
  mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ mysql_root_password }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
    priv: "*.*:ALL,GRANT"
    state: present
  loop:
    - 127.0.0.1
   